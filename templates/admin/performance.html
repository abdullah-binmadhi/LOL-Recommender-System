{% extends "base.html" %}

{% block title %}Performance Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Performance Dashboard</h1>
            
            {% if data.error %}
                <div class="alert alert-danger">
                    <strong>Error:</strong> {{ data.error }}
                </div>
            {% else %}
                <!-- Health Scores -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Overall Health</h5>
                                <div class="display-4 {% if data.health_scores.overall >= 80 %}text-success{% elif data.health_scores.overall >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ data.health_scores.overall }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Cache Performance</h5>
                                <div class="display-4 {% if data.health_scores.cache >= 80 %}text-success{% elif data.health_scores.cache >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ data.health_scores.cache }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Response Performance</h5>
                                <div class="display-4 {% if data.health_scores.performance >= 80 %}text-success{% elif data.health_scores.performance >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ data.health_scores.performance }}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cache Statistics -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Cache Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <strong>Hit Rate:</strong> {{ data.cache_performance.hit_rate }}%
                                    </div>
                                    <div class="col-6">
                                        <strong>Memory Entries:</strong> {{ data.cache_performance.memory_entries }}
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <strong>Disk Entries:</strong> {{ data.cache_performance.disk_entries }}
                                    </div>
                                    <div class="col-6">
                                        <strong>Memory Size:</strong> {{ data.cache_performance.memory_size_mb }} MB
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <strong>Hits:</strong> {{ data.cache_performance.hits }}
                                    </div>
                                    <div class="col-6">
                                        <strong>Misses:</strong> {{ data.cache_performance.misses }}
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <strong>Evictions:</strong> {{ data.cache_performance.evictions }}
                                    </div>
                                    <div class="col-6">
                                        <strong>Compression Saves:</strong> {{ data.cache_performance.compression_saves }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">System Status</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <strong>Monitoring:</strong> 
                                        <span class="badge {% if data.monitoring_active %}badge-success{% else %}badge-danger{% endif %}">
                                            {% if data.monitoring_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </div>
                                    <div class="col-6">
                                        <strong>Optimization Tasks:</strong> {{ data.optimization_tasks }}
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <strong>Last Updated:</strong> {{ data.timestamp }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics -->
                {% if data.operation_performance.summary.operations %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Operation Performance</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Operation</th>
                                                <th>Count</th>
                                                <th>Avg Time (ms)</th>
                                                <th>Min Time (ms)</th>
                                                <th>Max Time (ms)</th>
                                                <th>P95 Time (ms)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for operation, metrics in data.operation_performance.summary.operations.items() %}
                                            <tr>
                                                <td>{{ operation }}</td>
                                                <td>{{ metrics.count }}</td>
                                                <td>{{ "%.2f"|format(metrics.avg_time * 1000) }}</td>
                                                <td>{{ "%.2f"|format(metrics.min_time * 1000) }}</td>
                                                <td>{{ "%.2f"|format(metrics.max_time * 1000) }}</td>
                                                <td>{{ "%.2f"|format(metrics.p95_time * 1000) }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Recommendations -->
                {% if data.recommendations %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Optimization Recommendations</h5>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    {% for recommendation in data.recommendations %}
                                    <li class="list-group-item">
                                        <i class="fas fa-lightbulb text-warning"></i>
                                        {{ recommendation }}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Control Panel -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Control Panel</h5>
                            </div>
                            <div class="card-body">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-primary" onclick="forceOptimization('all')">
                                        <i class="fas fa-rocket"></i> Force Full Optimization
                                    </button>
                                    <button type="button" class="btn btn-info" onclick="forceOptimization('cache')">
                                        <i class="fas fa-database"></i> Optimize Cache
                                    </button>
                                    <button type="button" class="btn btn-warning" onclick="clearCache()">
                                        <i class="fas fa-trash"></i> Clear All Caches
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="refreshDashboard()">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function forceOptimization(type) {
    fetch('/admin/optimize', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({type: type})
    })
    .then(response => response.json())
    .then(data => {
        if (data.executed && data.executed.length > 0) {
            alert('Optimization completed: ' + data.executed.join(', '));
        }
        if (data.errors && data.errors.length > 0) {
            alert('Optimization errors: ' + data.errors.join(', '));
        }
        setTimeout(refreshDashboard, 2000);
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function clearCache() {
    if (confirm('Are you sure you want to clear all caches? This will temporarily reduce performance.')) {
        fetch('/admin/clear-cache', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Caches cleared successfully. Cleared ' + data.cleared_entries + ' entries.');
            } else {
                alert('Error clearing caches: ' + data.error);
            }
            setTimeout(refreshDashboard, 2000);
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

function refreshDashboard() {
    location.reload();
}

// Auto-refresh every 30 seconds
setInterval(refreshDashboard, 30000);
</script>
{% endblock %}